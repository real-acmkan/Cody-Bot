<html>

<head>
	<script src="https://webrtc.github.io/adapter/adapter-4.2.2.js"></script>
</head>

<style>
	body {
		background: #c2e59c;
		/* fallback for old browsers */
		background: -webkit-linear-gradient(to bottom, #64b3f4, #c2e59c);
		/* Chrome 10-25, Safari 5.1-6 */
		background: linear-gradient(to bottom, #64b3f4, #c2e59c);
		/* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
	}

	h1 {
		color: #ffffff;
		font-family: 'Raleway', sans-serif;
		font-size: 62px;
		font-weight: 800;
		line-height: 72px;
		margin: 0 0 24px;
		text-align: center;
		text-transform: uppercase
	}

	button {
		color: blue;
		background: lightgrey;
		border: 1px solid #000;
		border-radius: 8px;
		position: center;
	}

	p {
		font-family: 'Inder', sans-serif;
		line-height: 28px;
		margin-bottom: 15px;
		color: #222;
	}
</style>

<body>

	<div style="text-align:center">

		<h1> Cody Kirk's Robot <img style="height: 100px" src="images/robot52.png"> </h1>
		<br><br>

		<div id="remotes" class="row">
			<div class="col-md-6">
				<div class="videoContainer">
					<video id="selfVideo" oncontextmenu="return false;"></video>
					<meter id="localVolume" class="volume" min="-45" max="-20" high="-25" low="-40"></meter>
				</div>
			</div>
		</div>
	</div>

	<script>
		var okta = new OktaSignIn({
			baseUrl: "https://dev-111464.oktapreview.com",
			clientId: "0oaejf8gmll1TiDRz0h7",
			authParams: {
				issuer: "https://dev-111464.oktapreview.com/oauth2/default",
				responseType: ["token", "id_token"],
				display: "page"
			}
		});

		// Render the login form.
		function showLogin() {
			okta.renderEl({ el: "#okta-login-container" }, function(res) {}, function(err) {
				alert("Couldn't render the login form, something horrible must have happened. Please refresh the page.");
			});
		}

		// Determine the room name and public URL for this chat session.
		function getRoom() {
			var query = location.search && location.search.split("?")[1];

			if (query) {
				return (location.search && decodeURIComponent(query.split("=")[1]));
			}

			return okta.tokenManager.get("idToken").claims.email;
		}

		// Retrieve the absolute room URL.
		function getRoomURL() {
			return location.protocol + "//" + location.host + (location.path || "") + "?room=" + getRoom();
		}

		// Determine whether or not we have a querystring.
		function hasQueryString() {
			return location.href.indexOf("?") !== -1;
		}

		// Handle the user's login and what happens next.
		function handleLogin() {
			// If the user is logging in for the first time...
			if (okta.token.hasTokensInUrl()) {
				okta.token.parseTokensFromUrl(
					function success(res) {
						// Save the tokens for later use, e.g. if the page gets refreshed:
						okta.tokenManager.add("accessToken", res[0]);
						okta.tokenManager.add("idToken", res[1]);

						// Redirect to this user's dedicated room URL.
						window.location = getRoomURL();
					}, function error(err) {
						alert("We weren't able to log you in, something horrible must have happened. Please refresh the page.");
					}
				);
			} else {
				okta.session.get(function(res) {

					// If the user is logged in, display the app.
					if (res.status === "ACTIVE") {

						// If the user is logged in on the home page, redirect to their room page.
						if (!hasQueryString()) {
							window.location = getRoomURL();
						}

						return enableVideo();
					}

					// If we get here, the user is not logged in.

					// If there's a querystring in the URL, it means this person is in a
					// "room" so we should display our passive login notice. Otherwise,
					// we'll prompt them for login immediately.
					if (hasQueryString()) {
						document.getElementById("login").style.display = "block";
						enableVideo();
					} else {
						showLogin();
					}
				});
			}
		}

		// Enable video on the page.
		function enableVideo() {
			document.getElementById("url").style.display = "block";
			document.getElementById("remotes").style.visibility = "visible";
			loadSimpleWebRTC();
		}

		// Dynamically load the simplewebrtc script so that we can
		// kickstart the video call.
		function loadSimpleWebRTC() {
			var script = document.createElement("script");
			script.src = "https://simplewebrtc.com/latest-v3.js";
			document.head.appendChild(script);

			script.onload = function() {
				var webrtc = new SimpleWebRTC({
					localVideoEl: "selfVideo",
					// the id/element dom element that will hold remote videos
					remoteVideosEl: "",
					autoRequestMedia: true,
					debug: false,
					detectSpeakingEvents: true,
					autoAdjustMic: false
				});

				// Set the publicly available room URL.
				document.getElementById("roomUrl").innerText = getRoomURL();

				// Immediately join room when loaded.
				webrtc.on("readyToCall", function() {
					webrtc.joinRoom(getRoom());
				});

				function showVolume(el, volume) {
					if (!el) return;
					if (volume < -45) volume = -45; // -45 to -20 is
					if (volume > -20) volume = -20; // a good range
					el.value = volume;
				}

				// Display the volume meter.
				webrtc.on("localStream", function(stream) {
					var button = document.querySelector("form>button");
					if (button) button.removeAttribute("disabled");
					document.getElementById("localVolume").style.display = "block";
				});

				// If we didn't get access to the camera, raise an error.
				webrtc.on("localMediaError", function (err) {
					alert("This service only works if you allow camera access.Please grant access and refresh the page.");
				});

				// When another person joins the chat room, we'll display their video.
				webrtc.on("videoAdded", function(video, peer) {
					console.log("user added to chat", peer);
					var remotes = document.getElementById("remotes");

					if (remotes) {
						var outerContainer = document.createElement("div");
						outerContainer.className = "col-md-6";

						var container = document.createElement("div");
						container.className = "videoContainer";
						container.id = "container_" + webrtc.getDomId(peer);
						container.appendChild(video);

						// Suppress right-clicks on the video.
						video.oncontextmenu = function() { return false; };

						// Show the volume meter.
						var vol = document.createElement("meter");
						vol.id = "volume_" + peer.id;
						vol.className = "volume";
						vol.min = -45;
						vol.max = -20;
						vol.low = -40;
						vol.high = -25;
						container.appendChild(vol);

						// Show the connection state.
						if (peer && peer.pc) {
							var connstate = document.createElement("div");
							connstate.className = "connectionstate";
							container.appendChild(connstate);

							peer.pc.on("iceConnectionStateChange", function(event) {
								switch (peer.pc.iceConnectionState) {
									case "checking":
										connstate.innerText = "connecting to peer...";
										break;
									case "connected":
									case "completed": // on caller side
										vol.style.display = "block";
										connstate.innerText = "connection established";
										break;
									case "disconnected":
										connstate.innerText = "disconnected";
										break;
									case "failed":
										connstate.innerText = "connection failed";
										break;
									case "closed":
										connstate.innerText = "connection closed";
										break;
								}
							});
						}

						outerContainer.appendChild(container);
						remotes.appendChild(outerContainer);

						// If we're adding a new video we need to modify bootstrap so we
						// only get two videos per row.
						var remoteVideos = document.getElementById("remotes").getElementsByTagName("video").length;

						if (!(remoteVideos % 2)) {
							var spacer = document.createElement("div");
							spacer.className = "w-100";
							remotes.appendChild(spacer);
						}
					}
				});

				// If a user disconnects from chat, we need to remove their video feed.
				webrtc.on("videoRemoved", function(video, peer) {
					console.log("user removed from chat", peer);
					var remotes = document.getElementById("remotes");
					var el = document.getElementById("container_" + webrtc.getDomId(peer));
					if (remotes && el) {
						remotes.removeChild(el.parentElement);
					}
				});

				// If our volume has changed, update the meter.
				webrtc.on("volumeChange", function(volume, treshold) {
					showVolume(document.getElementById("localVolume"), volume);
				});

				// If a remote user's volume has changed, update the meter.
				webrtc.on("remoteVolumeChange", function(peer, volume) {
					showVolume(document.getElementById("volume_" + peer.id), volume);
				});

				// If there is a P2P failure, we need to error out.
				webrtc.on("iceFailed", function(peer) {
					var connstate = document.querySelector("#container_" + webrtc.getDomId(peer) + " .connectionstate");
					console.log("local fail", connstate);
					if (connstate) {
						connstate.innerText = "connection failed";
						fileinput.disabled = "disabled";
					}
				});

				// remote p2p/ice failure
				webrtc.on("connectivityError", function (peer) {
					var connstate = document.querySelector("#container_" + webrtc.getDomId(peer) + " .connectionstate");
					console.log("remote fail", connstate);
					if (connstate) {
						connstate.innerText = "connection failed";
						fileinput.disabled = "disabled";
					}
				});
			}
		}

		enableVideo();

							var xmlhttp;
							xmlhttp = new XMLHttpRequest();

							function forward() {
								xmlhttp.open("GET", "/cgi-bin/forward.cgi", true);
								xmlhttp.send();
							}

							function stop() {
								xmlhttp.open("GET", "/cgi-bin/stop.cgi", true);
								xmlhttp.send();
							}

							function left() {
								xmlhttp.open("GET", "/cgi-bin/left.cgi", true);
								xmlhttp.send();
							}

							function right() {
								xmlhttp.open("GET", "/cgi-bin/right.cgi", true);
								xmlhttp.send();
							}

							function reverse() {
								xmlhttp.open("GET", "/cgi-bin/reverse.cgi", true);
								xmlhttp.send();
							}

							function lowspeed() {
								xmlhttp.open("GET", "/cgi-bin/lowspeed.cgi", true);
								xmlhttp.send();
							}

							function regularspeed() {
								xmlhttp.open("GET", "/cgi-bin/regularspeed.cgi", true);
								xmlhttp.send();
							}

							function highspeed() {
								xmlhttp.open("GET", "/cgi-bin/highspeed.cgi", true);
								xmlhttp.send();
							}

							function nospeed() {
								xmlhttp.open("GET", "/cgi-bin/nospeed.cgi", true);
								xmlhttp.send();
							}

							document.onkeydown = checkKey;
							document.onkeyup = stopBot;

							function checkKey(e) {
								e = e || window.event;

								if (e.keyCode == '38') {
									forward();
									// up arrow
								} else if (e.keyCode == '40') {
									reverse();
									// down arrow
								} else if (e.keyCode == '37') {
									left();
									// left arrow
								} else if (e.keyCode == '39') {
									right();
									// right arrow
								}
							}

							function stopBot(e) {
								e = e || window.event;

								if (e.keyCode == '38') {
									stop();
								} else if (e.keyCode == "40") {
									stop();
								} else if (e.keyCode == '37') {
									stop();
								} else if (e.keyCode == '39') {
									stop();
								}
							}
	</script>

</body>

</html>
